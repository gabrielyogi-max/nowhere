<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIP-BOY 3000 // CHAT INTERFACE</title>
    <!-- Fallout-style font -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- Marked for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai-sublime.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            /* Fallout 4 Amber/Green Color Scheme - focusing on Green */
            --pip-green: #1eff00; 
            --pip-green-dim: #00b300;
            --pip-green-dark: #002b00;
            --pip-bg: #0d120d; /* Dark CRT screen */
            --scanline: rgba(0, 0, 0, 0.5);
            --crt-flicker: rgba(30, 255, 0, 0.05);
            --border-color: #1eff00;
        }

        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--pip-green) var(--pip-bg);
        }

        body {
            background-color: #000;
            color: var(--pip-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            text-transform: uppercase;
        }

        /* CRT Overlay Effect */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }

        .pipboy-frame {
            width: 100%;
            height: 100%;
            display: flex;
            background: var(--pip-bg);
            position: relative;
            box-shadow: 0 0 20px rgba(30, 255, 0, 0.2);
        }

        /* Sidebar - Model Selection & Status */
        .sidebar {
            width: 300px;
            background: rgba(0, 20, 0, 0.8);
            border-right: 2px solid var(--pip-green);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
        }

        .brand {
            font-size: 2rem;
            text-shadow: 0 0 10px var(--pip-green);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--pip-green);
            padding-bottom: 10px;
            text-align: center;
        }

        .status-panel {
            font-size: 0.8rem;
            margin-bottom: 20px;
            border: 1px dashed var(--pip-green-dim);
            padding: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .status-on { color: var(--pip-green); text-shadow: 0 0 5px var(--pip-green); }
        .status-off { color: red; text-shadow: 0 0 5px red; }

        .model-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .model-group-title {
            margin-top: 15px;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--pip-green-dim);
            color: var(--pip-green-dim);
            margin-bottom: 5px;
        }

        /* Custom Radio Buttons for Models */
        .model-option {
            display: block;
            cursor: pointer;
            padding: 8px;
            margin: 5px 0;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 0.9rem;
        }

        .model-option:hover {
            background: var(--pip-green-dark);
            border: 1px solid var(--pip-green-dim);
        }

        .model-option input {
            display: none;
        }

        .model-option.selected {
            background: var(--pip-green);
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 10px var(--pip-green);
        }

        /* Main Chat Area */
        .main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .chat-history {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border: 1px solid var(--pip-green);
            position: relative;
            line-height: 1.4;
            word-wrap: break-word;
            /* Boxy aesthetic */
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 10px), 
                calc(100% - 10px) 100%, 
                0 100%
            );
        }

        .message.bot {
            align-self: flex-start;
            background: rgba(0, 43, 0, 0.3);
        }

        .message.user {
            align-self: flex-end;
            background: var(--pip-green);
            color: #000;
            /* Invert clip path for variety if desired, but keeping consistent is fine */
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% 100%, 
                10px 100%, 
                0 calc(100% - 10px)
            );
        }

        .message strong {
            display: block;
            margin-bottom: 5px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Code Block Styling */
        .message pre {
            background: #111;
            border: 1px solid var(--pip-green-dim);
            padding: 10px;
            overflow-x: auto;
            margin: 10px 0;
            white-space: pre-wrap;
            text-transform: none; /* Keep code case-sensitive */
        }
        
        .message code {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9rem;
            text-transform: none; /* Keep code case-sensitive */
        }

        /* Input Area */
        .input-container {
            padding: 20px;
            background: rgba(0, 20, 0, 0.9);
            border-top: 2px solid var(--pip-green);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .prompt-char {
            font-size: 1.5rem;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink { 50% { opacity: 0; } }

        input[type="text"] {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--pip-green);
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            padding: 10px;
            text-transform: none; /* Let user type normally */
        }

        input[type="text"]:focus {
            outline: none;
        }

        button#sendBtn {
            background: transparent;
            color: var(--pip-green);
            border: 2px solid var(--pip-green);
            padding: 10px 20px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
        }

        button#sendBtn:hover {
            background: var(--pip-green);
            color: #000;
            box-shadow: 0 0 15px var(--pip-green);
        }

        button#sendBtn:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
            background: transparent;
            box-shadow: none;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--pip-green-dim);
            color: var(--pip-green-dim);
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }
        .action-btn:hover {
            background: var(--pip-green-dim);
            color: #000;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #001100; }
        ::-webkit-scrollbar-thumb { background: var(--pip-green-dim); border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: var(--pip-green); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .pipboy-frame {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: 200px; /* Collapsed height */
                border-right: none;
                border-bottom: 2px solid var(--pip-green);
            }
            .brand {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }
            .main-chat {
                height: calc(100vh - 200px);
            }
        }
    </style>
</head>
<body>

<div class="pipboy-frame">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="brand">PIP-BOY 3000</div>
        
        <div class="status-panel">
            <div class="status-item">
                <span>CLUSTER 1:</span>
                <span id="status-main" class="status-off">OFFLINE</span>
            </div>
            <div class="status-item">
                <span>CLUSTER 2:</span>
                <span id="status-math" class="status-off">OFFLINE</span>
            </div>
        </div>

        <div style="margin-bottom: 10px; font-weight: bold;">[ SELECIONAR MODELO ]</div>
        <div class="model-list" id="model-list-container">
            <!-- Models will be injected here via JS or static -->
            <!-- Google -->
            <div class="model-group-title">GOOGLE (CLUSTER 1)</div>
            <label class="model-option selected" onclick="selectModel(this, 'Cluster1|‚ú® Google: Gemini 1.5 Flash (R√°pido)')">
                <input type="radio" name="model" checked> GEMINI FLASH 1.5
            </label>
            <label class="model-option" onclick="selectModel(this, 'Cluster1|‚ú® Google: Gemini 1.5 Pro (Racioc√≠nio Avan√ßado)')">
                <input type="radio" name="model"> GEMINI PRO 1.5
            </label>

            <!-- Groq / Mistral -->
            <div class="model-group-title">GROQ / MISTRAL</div>
            <label class="model-option" onclick="selectModel(this, 'Cluster1|‚òÅÔ∏è Groq: Llama 3.3 70B (Vers√°til)')">
                <input type="radio" name="model"> LLAMA 3.3 70B
            </label>
            <label class="model-option" onclick="selectModel(this, 'Cluster1|‚òÅÔ∏è Groq: Llama 3.1 8B (Instant√¢neo)')">
                <input type="radio" name="model"> LLAMA 3.1 8B FLASH
            </label>
            <label class="model-option" onclick="selectModel(this, 'Cluster1|üá´üá∑ Mistral: Large 3 (SOTA Europeu)')">
                <input type="radio" name="model"> MISTRAL LARGE 3
            </label>
            <label class="model-option" onclick="selectModel(this, 'Cluster1|üá´üá∑ Mistral: Codestral (C√≥digo)')">
                <input type="radio" name="model"> MISTRAL CODESTRAL
            </label>

            <!-- Math -->
            <div class="model-group-title">M√ìDULO MATEM√ÅTICO</div>
            <label class="model-option" onclick="selectModel(this, 'Cluster2|üê≥ DeepSeek Math 7B (Especialista em Exatas)')">
                <input type="radio" name="model"> DEEPSEEK MATH 7B
            </label>
            <label class="model-option" onclick="selectModel(this, 'Cluster2|ü¶ô Llama 3 8B (Racioc√≠nio Geral)')">
                <input type="radio" name="model"> LLAMA 3 8B MATH
            </label>
            <label class="model-option" onclick="selectModel(this, 'Cluster2|üíé Gemma 2 9B (Google - Racioc√≠nio L√≥gico)')">
                <input type="radio" name="model"> GEMMA 2 9B
            </label>

            <!-- Local -->
            <div class="model-group-title">LOCAL H200</div>
            <label class="model-option" onclick="selectModel(this, 'Cluster1|üî• Local H200: Qwen 2.5 Coder 32B (Cota ZeroGPU)')">
                <input type="radio" name="model"> QWEN 2.5 CODER 32B
            </label>
        </div>

        <button class="action-btn" onclick="clearChat()">[ LIMPAR MEM√ìRIA ]</button>
    </div>

    <!-- Main Chat -->
    <div class="main-chat">
        <div class="chat-history" id="chat-history">
            <div class="message bot">
                <strong>SYSTEM</strong>
                INICIALIZANDO PROTOCOLOS DE COMUNICA√á√ÉO...<br>
                PIP-BOY 3000 ONLINE. AGUARDANDO CONEX√ÉO COM CLUSTERS.
            </div>
        </div>

        <div class="input-container">
            <span class="prompt-char">></span>
            <input type="text" id="userInput" placeholder="INSIRA COMANDO..." onkeypress="handleEnter(event)" autofocus />
            <button id="sendBtn" onclick="sendMessage()">EXECUTAR</button>
        </div>
    </div>
</div>

<script type="module">
    import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";

    // Initialize Marked with Highlight.js
    if (window.marked && window.hljs) {
        marked.setOptions({
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });
    }

    // --- CONFIGURA√á√ÉO DOS SPACES ---
    const CLUSTERS = {
        "Cluster1": "Madras1/APIDOST",
        "Cluster2": "Madras1/APISMALL"
    };

    let clients = {}; 
    let currentModelValue = "Cluster1|‚ú® Google: Gemini 1.5 Flash (R√°pido)"; // Default

    const statusMain = document.getElementById('status-main');
    const statusMath = document.getElementById('status-math');
    const sendBtn = document.getElementById('sendBtn');
    const historyDiv = document.getElementById('chat-history');

    // Make selectModel global
    window.selectModel = function(element, value) {
        // Visual selection
        document.querySelectorAll('.model-option').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        element.querySelector('input').checked = true;
        
        currentModelValue = value;
        console.log("Modelo selecionado:", value);
    }

    // 1. Inicializa√ß√£o
    async function initSystem() {
        appendMessage("bot", "<strong>SYSTEM</strong> TENTANDO CONEX√ÉO COM CLUSTERS...");
        
        // Conecta Cluster 1
        try {
            clients["Cluster1"] = await Client.connect(CLUSTERS["Cluster1"]);
            statusMain.innerText = "ONLINE";
            statusMain.className = "status-on";
        } catch (e) {
            statusMain.innerText = "ERRO";
            console.error("Erro Cluster 1:", e);
        }

        // Conecta Cluster 2
        try {
            clients["Cluster2"] = await Client.connect(CLUSTERS["Cluster2"]);
            statusMath.innerText = "ONLINE";
            statusMath.className = "status-on";
        } catch (e) {
            statusMath.innerText = "ERRO";
            console.error("Erro Cluster 2:", e);
        }

        appendMessage("bot", "<strong>SYSTEM</strong> SISTEMA PRONTO.");
    }

    initSystem();

    // 2. Enviar Mensagem
    window.sendMessage = async function() {
        const input = document.getElementById('userInput');
        const userText = input.value;
        
        if (!userText.trim()) return;

        const [targetCluster, modelName] = currentModelValue.split('|');
        const activeClient = clients[targetCluster];

        if (!activeClient) {
            alert(`O ${targetCluster} EST√Å OFFLINE. VERIFIQUE CONEX√ÉO.`);
            return;
        }

        input.value = "";
        appendMessage("user", `<strong>USER</strong> ${userText}`, false); // Don't parse user input as markdown
        setLoading(true);

        try {
            const result = await activeClient.predict("/chat", { 
                message: userText, 
                model_selector: modelName 
            });

            const botResponse = result.data[0];
            appendMessage("bot", botResponse, true); // Parse bot response as markdown

        } catch (error) {
            console.error(error);
            let msg = "ERRO DESCONHECIDO.";
            
            if(error.message.includes("GPU quota")) {
                msg = `‚ö†Ô∏è COTA DE GPU EXCEDIDA (${targetCluster}).`;
            } else if (error.message.includes("aborted")) {
                msg = "‚ö†Ô∏è TAREFA ABORTADA. RECURSOS INDISPON√çVEIS.";
            } else {
                msg = "ERRO NO PROCESSAMENTO: " + error.message;
            }
            appendMessage("bot", `<strong>ERRO</strong> ${msg}`, false);
        } finally {
            setLoading(false);
        }
    }

    function appendMessage(role, text, isMarkdown = false) {
        const div = document.createElement('div');
        div.className = "message " + role;
        
        if (role === 'bot' && isMarkdown && window.marked) {
            // Helper to add the header before parsing markdown
            // But 'text' is just the raw response.
            // The <strong>SYSTEM</strong> part is added in the sendMessage for clarity,
            // but here let's stick to the content.
            // Wait, in previous code: appendMessage("bot", `<strong>SYSTEM</strong> ${botResponse}`);
            // If I parse Markdown, I need to be careful not to break the HTML header.
            
            // Let's restructure: text passed here is the RAW content.
            // The "SYSTEM" prefix should be handled separately or pre-pended safely.
            
            // However, the current usage is: appendMessage("bot", `<strong>SYSTEM</strong> ${botResponse}`);
            // This mixes HTML and Markdown.
            
            // FIX: Let's assume the text passed to this function is HTML-safe if isMarkdown=false.
            // If isMarkdown=true, we assume 'text' is the raw markdown content, and we prepend the header manually.
            
            // Re-reading usage: 
            // appendMessage("bot", botResponse, true);
            
            const header = role === 'bot' ? '<strong>SYSTEM</strong> ' : '<strong>USER</strong> ';
            div.innerHTML = header + marked.parse(text);
        } else {
            div.innerHTML = text;
        }
        
        historyDiv.appendChild(div);
        historyDiv.scrollTop = historyDiv.scrollHeight;
    }

    function setLoading(isLoading) {
        if (isLoading) {
            sendBtn.disabled = true;
            sendBtn.innerText = "PROC...";
        } else {
            sendBtn.disabled = false;
            sendBtn.innerText = "EXECUTAR";
            document.getElementById('userInput').focus();
        }
    }

    window.clearChat = function() {
        historyDiv.innerHTML = '<div class="message bot"><strong>SYSTEM</strong> MEM√ìRIA LIMPA.</div>';
    }

    window.handleEnter = function(e) {
        if (e.key === 'Enter') window.sendMessage();
    }
</script>

</body>
</html>
